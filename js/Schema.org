// ===========================================
// ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
// ===========================================
const CONFIG = {
    API_KEY: "882e741f7283dc9ba1654d4692ec30f6",
    BASE_URL: "https://api.themoviedb.org/3",
    BASE_IMG: "https://image.tmdb.org/t/p"
};

// ===========================================
// ŸÖÿ™ÿ∫Ÿäÿ± Swiper ÿßŸÑÿπÿßŸÖ
// ===========================================
let swiperInstance = null;
let currentPage = 3;
let isLoadingMore = false;
let allMoviesData = [];

async function fetchPopularMovies() {
    try {
        showLoading(true);
        allMoviesData = [];

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ£ŸàŸÑŸâ ŸÖÿ®ÿßÿ¥ÿ±ÿ©
        const response = await fetch(`${CONFIG.BASE_URL}/movie/popular?api_key=${CONFIG.API_KEY}&language=en-SA&page=1`);
        const data = await response.json();
        allMoviesData.push(...data.results);

        // ÿπÿ±ÿ∂ ÿßŸÑÿ£ŸÅŸÑÿßŸÖ ŸÖÿ®ÿßÿ¥ÿ±ÿ©
        displayMovies(allMoviesData);
        initSwiper();

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿßÿ™ ÿßŸÑÿ£ÿÆÿ±Ÿâ ŸÅŸä ÿßŸÑÿÆŸÑŸÅŸäÿ©
        const pages = [2, 3];
        for (const page of pages) {
            fetch(`${CONFIG.BASE_URL}/movie/popular?api_key=${CONFIG.API_KEY}&language=en-SA&page=${page}`)
                .then(res => res.json())
                .then(data => {
                    allMoviesData.push(...data.results);
                    addMoviesToSwiper(data.results);
                })
                .catch(err => console.log('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿµŸÅÿ≠ÿ© ÿ•ÿ∂ÿßŸÅŸäÿ©:', err));
        }

        console.log(`‚úÖ ÿ®ÿØÿ£ÿ™ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÅŸÑÿßŸÖ`);

    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿßŸÑÿ£ŸÅŸÑÿßŸÖ:', error);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÅŸÑÿßŸÖ');
    } finally {
        showLoading(false);
    }
}

// ===========================================
// ÿØÿßŸÑÿ© ÿ¨ŸÑÿ® ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑÿ£ŸÅŸÑÿßŸÖ
// ===========================================
async function loadMoreMovies() {
    if (isLoadingMore) return;
    
    isLoadingMore = true;
    currentPage++;
    
    try {
        console.log(`üì• ÿ¨ŸÑÿ® ÿµŸÅÿ≠ÿ© ${currentPage}...`);
        
        const response = await fetch(
            `${CONFIG.BASE_URL}/movie/popular?api_key=${CONFIG.API_KEY}&language=en-SA&page=${currentPage}`
        );
        
        if (!response.ok) {
            throw new Error('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑÿ£ŸÅŸÑÿßŸÖ');
        }
        
        const data = await response.json();
        const newMovies = data.results;
        
        if (newMovies.length > 0) {
            allMoviesData.push(...newMovies);
            addMoviesToSwiper(newMovies);
            console.log(`‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ${newMovies.length} ŸÅŸäŸÑŸÖ ÿ¨ÿØŸäÿØ - ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: ${allMoviesData.length}`);
        }
        
    } catch (error) {
        console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿßŸÑŸÖÿ≤ŸäÿØ:', error);
    } finally {
        isLoadingMore = false;
    }
}

// ===========================================
// ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ ÿßŸÑÿ£ŸÅŸÑÿßŸÖ ŸÅŸä Swiper
// ===========================================
function displayMovies(moviesList) {
    const container = document.getElementById('movies-container');
    
    if (!container) {
        console.error('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑÿ≠ÿßŸàŸäÿ©');
        return;
    }
    
    container.innerHTML = '';
    
    moviesList.forEach(movie => {
        createMovieSlide(movie, container);
    });
}

// ===========================================
// ÿØÿßŸÑÿ© ÿ•ŸÜÿ¥ÿßÿ° ÿ¥ÿ±Ÿäÿ≠ÿ© ŸÅŸäŸÑŸÖ
// ===========================================
function createMovieSlide(movie, container) {
    const posterPath = movie.poster_path 
        ? `${CONFIG.BASE_IMG}/w500${movie.poster_path}`
        : 'https://via.placeholder.com/300x450/1a1a1a/fff?text=No+Image';
    
    const rating = movie.vote_average ? movie.vote_average.toFixed(1) : '--';
    const year = movie.release_date ? movie.release_date.split('-')[0] : '--';
    
    const movieName = movie.title || movie.original_title || 'ÿ®ÿØŸàŸÜ ÿπŸÜŸàÿßŸÜ';
    
    const slide = document.createElement('div');
    slide.className = 'swiper-slide';
    slide.setAttribute('data-movie-id', movie.id);
    slide.onclick = () => openMoviePage(movie.id);
    
    slide.innerHTML = `
        <img src="${posterPath}" alt="${movieName}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x450/1a1a1a/fff?text=ŸÑÿß+ÿ™Ÿàÿ¨ÿØ+ÿµŸàÿ±ÿ©'">
        <div class="series-info">
            <div class="series-title">${movieName}</div>
            <div class="series-meta">
                <span>${year}</span>
                <span class="series-rating">
                    ‚≠ê ${rating}
                </span>
            </div>
        </div>
    `;
    
    container.appendChild(slide);
}

// ===========================================
// ÿØÿßŸÑÿ© ÿ•ÿ∂ÿßŸÅÿ© ÿ£ŸÅŸÑÿßŸÖ ÿ¨ÿØŸäÿØÿ© ŸÑŸÑŸÄ Swiper
// ===========================================
function addMoviesToSwiper(newMovies) {
    const container = document.getElementById('movies-container');
    
    if (!container || !swiperInstance) return;
    
    newMovies.forEach(movie => {
        createMovieSlide(movie, container);
    });
    
    swiperInstance.update();
}

// ===========================================
// ÿØÿßŸÑÿ© ŸÅÿ™ÿ≠ ÿµŸÅÿ≠ÿ© ÿßŸÑŸÅŸäŸÑŸÖ
// ===========================================
function openMoviePage(movieId) {
    console.log('üé¨ ŸÅÿ™ÿ≠ ÿµŸÅÿ≠ÿ© ÿßŸÑŸÅŸäŸÑŸÖ:', movieId);
    window.location.href = `watch-movie.html?id=${movieId}`;
}

// ===========================================
// ÿØÿßŸÑÿ© ÿ™ŸáŸäÿ¶ÿ© Swiper
// ===========================================
function initSwiper() {
    if (swiperInstance) {
        swiperInstance.destroy(true, true);
    }
    
    swiperInstance = new Swiper(".swiper-container", {
        slidesPerView: 2,
        slidesPerGroup: 1,
        centeredSlides: true,
        loop: true,
        spaceBetween: 0,
        grabCursor: true,
        touchEventsTarget: 'container',
        simulateTouch: true,
        allowTouchMove: true,
        touchRatio: 1,
        touchAngle: 45,
        longSwipes: true,
        longSwipesRatio: 0.5,
        longSwipesMs: 300,
        followFinger: true,
        freeMode: false,
        freeModeSticky: false,
        autoplay: {
            delay: 4000,
            disableOnInteraction: false,
            pauseOnMouseEnter: true
        },
        speed: 800,
        mousewheel: {
            enabled: false
        },
        breakpoints: {
            600: { slidesPerView: 2, slidesPerGroup: 2, spaceBetween: 0, centeredSlides: true },
            900: { slidesPerView: 3, slidesPerGroup: 3, spaceBetween: 0, centeredSlides: false },
            1200: { slidesPerView: 4, slidesPerGroup: 4, spaceBetween: 0, centeredSlides: false },
            1500: { slidesPerView: 5, slidesPerGroup: 5, spaceBetween: 0, centeredSlides: false },
            1800: { slidesPerView: 6, slidesPerGroup: 6, spaceBetween: 0, centeredSlides: false }
        }
    });
    
    setupCustomArrows();
    
    const swiperContainer = document.querySelector('.swiper-container');
    if (swiperContainer) {
        swiperContainer.addEventListener('mouseenter', () => {
            if (swiperInstance && swiperInstance.autoplay) {
                swiperInstance.autoplay.stop();
            }
        });
        
        swiperContainer.addEventListener('mouseleave', () => {
            if (swiperInstance && swiperInstance.autoplay) {
                swiperInstance.autoplay.start();
            }
        });
    }
    
    console.log('‚úÖ Swiper ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ™Ÿá ÿ®ŸÜÿ¨ÿßÿ≠');
}

// ===========================================
// ÿØÿßŸÑÿ© ÿ±ÿ®ÿ∑ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸÖÿÆÿµÿµÿ©
// ===========================================
function setupCustomArrows() {
    const arrowRight = document.querySelector('.Arrow--Right');
    const arrowLeft = document.querySelector('.Arrow--Left');

    if (!swiperInstance) return;

    if (arrowRight) {
        arrowRight.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            swiperInstance.slideNext();

            if (swiperInstance.isEnd) {
                console.log('üìç ŸàÿµŸÑÿ™ ŸÑŸÑŸÜŸáÿßŸäÿ© - ÿ¨ŸÑÿ® ÿßŸÑŸÖÿ≤ŸäÿØ...');
                await loadMoreMovies();
            }
        });
    }

    if (arrowLeft) {
        arrowLeft.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            swiperInstance.slidePrev();
        });
    }

    swiperInstance.on('reachEnd', async () => {
        console.log('üìç ŸàÿµŸÑÿ™ ŸÑŸÑŸÜŸáÿßŸäÿ© ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ≥ÿ≠ÿ® - ÿ¨ŸÑÿ® ÿßŸÑŸÖÿ≤ŸäÿØ...');
        await loadMoreMovies();
    });

    console.log('‚úÖ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸÖÿÆÿµÿµÿ© ÿ™ŸÖ ÿ±ÿ®ÿ∑Ÿáÿß ÿ®ŸÜÿ¨ÿßÿ≠');
}

// ===========================================
// ÿØÿßŸÑÿ© ÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
// ===========================================
function showLoading(show) {
    const loadingScreen = document.getElementById('loading-screen');
    if (loadingScreen) {
        loadingScreen.style.display = show ? 'flex' : 'none';
    }
}

// ===========================================
// ÿØÿßŸÑÿ© ÿßŸÑÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
// ===========================================
async function init() {
    console.log('üé¨ ÿ®ÿØÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÅŸÑÿßŸÖ...');
    
    await fetchPopularMovies();
    
    console.log(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ŸÅŸÑÿßŸÖ ÿ®ŸÜÿ¨ÿßÿ≠`);
}

// ===========================================
// ÿ®ÿØÿ° ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
// ===========================================
document.addEventListener('DOMContentLoaded', () => {
    init();
});